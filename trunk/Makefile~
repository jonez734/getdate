export PROJECT = getdate


export datestamp = $(shell date +%Y%m%d-%H%M)
export archivename = $(PROJECT)-$(datestamp)
export installfile = install --mode=0660 --verbose --preserve-timestamps

export PROJECTRELEASEDIR = /srv/repo/$(PROJECT)/
export PROJECTBUILDDIR = /home/jam/projects/$(PROJECT)/releases/$(archivename)/

# YACC = bison -r all --output y.tab.c
# CC = gcc -Wall -shared -fPIC -I/usr/include/python2.7/

CC = gcc
CFLAGS = -g -O2
CPPFLAGS =
LDFLAGS =
LDLIBS =
LEX = lex
YACC = bison
PYTHON = python

CFLAGS += -Wall -Wextra # -Werror=missing-prototypes -Werror=missing-declarations -Werror=redundant-decls
override CFLAGS += -fPIC # -fvisibility=hidden
override CPPFLAGS += $(shell ${PYTHON}-config --includes)
override LDFLAGS += -shared -Wl,-z,defs
override LDLIBS += $(shell ${PYTHON}-config --libs)

#OBJ=$(sort $(patsubst %.c, %.o, $(wildcard *.c)) $(patsubst %.y, %.tab.o, $(wildcard *.y)))

#%.tab.c: %.y
#	$(YACC) $< --output getdate.tab.c

all: libgetdate.so

clean:
	-rm *.o *.so *~

distclean: clean
	-rm *-parser.[ch]

# Actually generated by the same command, but multiple-output-files
# are awkward in Make.
%.h %.c : %.l
	${LEX} --header-file=$*.h -o $*.c $<
%.h %.c : %.y
	${YACC} --defines=$*.h -o $*.c $<
%.o: %.c
	${CC} ${CFLAGS} ${CPPFLAGS} -c -o $@ $<
%.so:
	${CC} ${LDFLAGS} $^ ${LDLIBS} -o $@

libgetdate.so: getdate-parser.o getdate-lexer-original.o pygetdate.o
getdate-lexer-original.o: getdate-lexer-original.c getdate-parser.h

lex.yy.c: getdate.l
	flex getdate.l

lex.yy.o: lex.yy.c
	gcc -shared -fPIC -o lex.yy.o lex.yy.c

#install: _getdate.so
#	install _getdate.so /usr/lib/python2.7/site-packages/
#
release:
	echo "-=- making a new release of $(PROJECT) -=-";
	echo $(archivename)
	mkdir -p -v $(PROJECTBUILDDIR);
	mkdir -p -v $(PROJECTRELEASEDIR);
	$(installfile) *.y *.l *.py *.h Makefile $(PROJECTBUILDDIR)
	pushd ../releases;\
	tar jcf $(archivename).tar.bz2 $(archivename)/*;\
	tar zcf $(archivename).tgz $(archivename)/*;\
	zip -r $(archivename).zip $(archivename)/*;\
	$(installfile) $(archivename).tar.bz2 $(archivename).tgz $(archivename).zip $(PROJECTRELEASEDIR);\
	$(installfile) $(archivename)/README.txt $(PROJECTRELEASEDIR);\
	popd;\
	echo "[DONE]"

rpm:	_getdate.so
	python ./setup.py bdist_rpm
